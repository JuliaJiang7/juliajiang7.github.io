---
title: 设计数据库的一些认识
date: 2020-07-12 10:58:22
tags:
  - Database
categories: Database
---

近期把之前一个小项目重新进行了规整，发现之前数据库设计存在很多问题。本文参考了一些数据库设计的基本规范以及经验等等，谈一些自己对于数据库设计的认识吧。

## 1. 关系数据库的范式

**[数据库规范化]([https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A7%84%E8%8C%83%E5%8C%96](https://zh.wikipedia.org/wiki/数据库规范化))**，又称正规化、标准化，是数据库设计的一系列原理和技术，以减少数据库中数据冗余，增进数据的一致性。

关系数据库的范式有：第一范式、第二范式、第三范式、BC范式（第三范式的改进范式），除外还包括针对多值依赖的第四范式，连接依赖的第五范式、DK范式和第六范式。

<!--more-->

现在数据库设计最多满足3NF，普遍认为范式过高，虽然具有对数据关系更好的约束性，但也导致数据关系表增加而令数据库IO更易繁忙，原来交由数据库处理的关系约束现更多在数据库使用程序中完成。

![image-20200426223214696](/pictures/image-20200426223214696.png)

### 1.1. 第一范式

[第一范式（1NF）]([https://zh.wikipedia.org/wiki/%E7%AC%AC%E4%B8%80%E6%AD%A3%E8%A6%8F%E5%8C%96](https://zh.wikipedia.org/wiki/第一正規化)) 是数据库正规化所使用的正规形式。第一范式是为了要排除 *重复组* 的出现，所采用的方法是要求数据库的每个列的值域都是由 **原子值** 组成；每个字段的值都只能是单一值。

不符合第一范式的情况：

1. 重复组

   重复组通常会出现在会计账上，每一笔记录可能有不定个数的值。举例来说：

   <img src="/pictures/image-20200426223643952.png"/>

   “数量”就是所谓的重复组了，而在这种情况下这份数据就不符合第一范式。想要消除重复组的话，只要把每笔记录都转化为单一记录即可：

   <img src="/pictures/image-20200426223715720.png" />

2. 缺乏唯一标识符

   一样是在交易这个例子中，同一天同一个人买了同样的数量，这样的交易做了两次：

   <img src="/pictures/image-20200426224653184.png" />

   如上所示，这两笔交易可以说是一模一样，也就是说如果只靠这些数据我们没有办法分辨这两笔记录。我们之所以说它不符合第一范式，是因为上面这样的表示法欠缺一个唯一标识符，可以是一个字段，也可以是一组字段，而且可以保证在这个数据中唯一标识符不会重复出现。要将它正规化到符合第一范式的原则只需要加入一个唯一标识符即可：

   <img src="/pictures/image-20200426224741598.png"  />

3. 单一字段中有多个有意义的值

   在单一字段中存放多个值是违反第一范式的做法，下面这个就是很好的例子，它把多个值用逗号分开来表示：

   <img src="/pictures/image-20200426225059906.png" />

   以这样的设计看来，想要知道有什么人不喜欢某样特定的东西是很不容易的。不过可以把这个数据表转化成下面这种符合第一范式的型式：

   <img src="/pictures/image-20200426225223170.png" />

4. 用很多字段来表达同一个事实

   在同一个数据表里用多个字段来表达同一个事情也是违反第一范式的：

   <img src="/pictures/image-20200426225402284.png" />

   就算我们能确定每个人不喜欢吃的食物最多不会超过三样，这还是一个很糟的设计。举例来说，我们想要知道所有不喜欢同一种食物的人的组合的话，这就不是件容易的事，因为食物有可能出现在任何一个字段，也就是说每一次的查询都要去检查 9 (3 x 3) 组不同的字段组合。

### 1.2. 第二范式

**[第二范式（2NF）]([https://zh.wikipedia.org/wiki/%E7%AC%AC%E4%BA%8C%E6%AD%A3%E8%A6%8F%E5%8C%96](https://zh.wikipedia.org/wiki/第二正規化))** 是数据库正规化所使用的正规形式。规则是要求数据表里的所有数据都要和该数据表的键（主键与*候选键 [下文有介绍 ]*）有完全依赖关系：每个非键属性必须独立于任意一个候选键的任意一部分属性。如果有哪些数据只和一个键的一部分有关的话，就得把它们独立出来变成另一个数据表。如果一个数据表的键只有单个字段的话，它就一定符合第二范式。

一个数据表符合第二范式当且仅当：

- 它符合第一范式
- 所有非键字段都不能是候选键非全体字段的函数

示例：

有一个数据表记录了设备组件的信息，如下所示

<img src="/pictures/image-20200426230751958.png"  />

这个数据表的每个值都是单一值，所以它符合第一范式。因为同一个组件有可能由不同的供应商提供，所以得把组件 ID 和供应商 ID 合在一起组成一个主键。

组件（关键词）和价格之间的关系很正确：同一个组件在不同供应商有可能会有不同的报价，所以价格确实和主键完全相关（完全依赖）。

另一方面，供应商的名称和住址就只和供应商 ID 有关（部分依赖），这不符合第二范式的原则。仔细看就会发现 "Stylized Parts" 这个名称和 "VA" 这个住址重复出现了两次；要是它改名了或是被其他公司并购了怎么办？这时候最好把这些数据存到第二个数据表中：

<img src="/pictures/image-20200426230943516.png" />

这么一来，原本的 "组件来源" 数据表就得要做相对应的改动：

<img src="/pictures/image-20200426231044849.png" />

检查数据表里的每个字段，确认它们是不是都和关键词完全相关， 这样才能知道这个数据表是不是符合第二范式； 如果不是的话，就把那些不完全相关的字段移到独立的数据表里。 接下来的步骤是要确保所有不是键的字段都和彼此没有相依关系，这就叫做 [第三范式](https://zh.wikipedia.org/wiki/第三正規化)。

### 1.3. 第三范式

**[第三范式（3NF）]([https://zh.wikipedia.org/wiki/%E7%AC%AC%E4%B8%89%E6%AD%A3%E8%A6%8F%E5%8C%96](https://zh.wikipedia.org/wiki/第三正規化))** 是数据库正规化所使用的正规形式，要求所有非主键属性都只和候选键有相关性，也就是说非主键属性之间应该是独立无关的。如果再对第三范式做进一步加强就成了[BC正规化](https://zh.wikipedia.org/wiki/BC正規化)，强调的重点在于“数据间的关系是奠基在主键上、以整个主键为考量、而且除了主键之外不考虑其他因素”。

以下面这个定义机械组件的关系为例：

<img src="/pictures/image-20200427232114257.png" />

本例中制造商地址很明显地不该被列在这个关系里面，因为和组件本身比起来，制造商地址应该和制造商比较有关系；正确的做法应该是把独立成为一个新的数据表：

<img src="/pictures/image-20200427232353749.png" />

然后把原本的数据表改成这样：

<img src="/pictures/image-20200427232447340.png" />

先前那个数据表的问题在于每提到一次制造商名称就要多存一次它的地址，而这就不符合第三范式的原则。

下面提供了另一个例子：

<img src="/pictures/image-20200427232554631.png" />

在本例中，非主键字段完全依赖于主键订单编号，也就是说唯一的订单编号能导出唯一非主键字段值，符合第二范式。第三范式要求非主键字段之间不能有依赖关系，显然本例中小计依赖于非主键字段“单价”和“数量”，不符合第三范式。小计不应该放在这个数据表里面，只要把单价乘上数量就可以得到小计了；如果想要符合第三范式的话，就把小计拿掉吧 (不过在做查询的时候，本来用 SELECT Order.Total FROM Order 就要改成用 SELECT UnitPrice * Quantity FROM Order 了)。

<img src="/pictures/image-20200427232650317.png" />

### 1.4. 第四范式

**[第四正规化（4NF）]([https://zh.wikipedia.org/wiki/%E7%AC%AC%E5%9B%9B%E6%AD%A3%E8%A6%8F%E5%8C%96](https://zh.wikipedia.org/wiki/第四正規化))** 是数据库正规化中所使用的一种正规形式，是BC范式之后的另一层次的规范化。第二范式、第三范式、BC范式关注于属性集合之间的函数依赖；而第四范式关注更一般形式称作 **多值依赖**。

例子：

<img src="/pictures/image-20200428230552342.png" />

每一行指出一家饭店能提供一种披萨与一个配货地区。

该表没有非键属性，因为它仅有的键是{Restaurant, Pizza Variety, Delivery Area}。因此，它满足到BC范式为止的所有范式。如果假设，饭店提供的披萨种类与配货地区无关。也即饭店为所有的供货地区提供它能制作的所有披萨类型。那么，这个表不满足第四范式。因为这个表在{Restaurant}属性（它不是超键）上提供了两个非平凡的多值依赖:

- {Restaurant} -> {Pizza Variety}
- {Restaurant} -> {Delivery Area}

这些在一个非超键上的非平凡多值依赖说明了饭店提供的披萨的多样性独立于饭店的供货地区。这导致了该表中的数据冗余：例如，A1 Pizza供货 Stuffed Crust就重复了3遍；如果A1 Pizza开始生产Cheese Crust pizzas那么向表中增加多行，A1 Pizza的每个供货地区都需要一行。这就可能在给A1 Pizza的每个供货地区增加一行Cheese Crust披萨时，遗漏了一个供货地区，从而导致不满足于多值依赖{Restaurant}->{Pizza Variety}。

为了避免上述的错误发生，需要把披萨的多样性与供货地区放置在不同的表中，产生了两张满足第四范式的表：

<img src="/pictures/image-20200428231345713.png" />

如果披萨的种类随着供货地区不同而变化，那么最初的三列的表就满足第四范式。

### 1.5. 第五范式

**[第五范式 (5NF)]([https://zh.wikipedia.org/wiki/%E7%AC%AC%E4%BA%94%E8%8C%83%E5%BC%8F](https://zh.wikipedia.org/wiki/第五范式))**，也称投影-连接范式（project-join normal form，PJ/NF）是数据库规范化的一个级别，以去除多个关系之间的语义相关。一张表满足第五范式当且仅当它的每个连接依赖可由候选键推出。

例子：

<img src="/pictures/image-20200428232129091.png" />

三列共同组成了主键。该表也满足第四范式，因为不存在多值依赖。

如果没有任何规则限制上门推销员、品牌、产品类型的组合，那么上述三个属性的表是必须的以描述这些数据。但是，如果假定存在下述规则：如果上门推销员经营某个品牌与某个产品类型，那么该推销员必须经营该品牌制造的该产品类型的商品。这种情形下，可以把上表分为三个表：

![image-20200428232253846](/pictures/image-20200428232253846.png)

在这种情形下，如果上门推销员推销Acme的其它类型的产品也推销其它品牌的真空吸尘器，则他Louis Ferguson不可能拒绝销售由ACME制造的真空吸尘器（Vacuum Cleaner）。

注意这种方式是如何去除数据冗余。假设经营面包箱与真空吸尘器的上门推销员Jack Schneider开始新增销售Robusto品牌。在最初的那张表中，需要增加两行： (<Jack Schneider, Robusto, Breadboxes>, <Jack Schneider, Robusto, Vacuum Cleaners>)。而在分解后的三张表的设计中，仅需要在表“Brands By Traveling Salesman”中增加一行：(<Jack Schneider, Robusto>)。

用途：

仅在很少情况下满足第四范式的表可能会不满足第五范式。这发生在复杂的真实世界的约束限定了属性的有效组合，但不能在满足第四范式的表的结构中体现出来。这种表如果不能规范化为第五范式，就需要应用程序通过插入、修改、删除等操作来维护表中的数据的逻辑一致性。相反，满足第五范式的表的设计排除了这种不一致性。

## 2. 关系键

**[关系键]([https://zh.wikipedia.org/wiki/%E5%85%B3%E7%B3%BB%E9%94%AE](https://zh.wikipedia.org/wiki/关系键))** 是关系数据库的重要组成部分。关系键是一个表中的一个或几个属性，用来标识该表的每一行或与另一个表产生联系。

![img](/pictures/280px-PrimaryKey_zht.svg.png)

## 3. 书写高质量SQL的建议

[MySQL高性能优化规范建议](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485117&idx=1&sn=92361755b7c3de488b415ec4c5f46d73&chksm=cea24976f9d5c060babe50c3747616cce63df5d50947903a262704988143c2eeb4069ae45420&token=79317275&lang=zh_CN#rd)

